# UW-Logic

”UW-Logic“文档描述潜器主要工作模式的工作逻辑，包括任务流、命令流和信息流的实现与交互。

潜器的主要工作模式包括甲板自检模式、水面模式、水下运动模式、下潜模式。



[toc]

## 一、甲板自检

### 1.1 甲板自检概述

甲板自检模式指潜器放置在甲板上，上电后进行各模块功能自检的模式。潜器上电后，潜器程序自动运行，主动执行甲板自检，依次对各部分关键模块进行上电自检，同时在主控终端的命令行显示自检信息并记录log，同时关键信息通过电台发送给甲板软件。

甲板自检顺序：

| 序号 | 名称          |
| ---- | ------------- |
| 1    | 主控程序      |
| 2    | 通讯电台      |
| 3    | 电池组        |
| 4    | 电控板（DAM） |
| 5    | IMU           |
| 6    | GPS           |
| 7    | 关节电机      |
| 8    | 主推进器      |
| 9    | ...           |

1.2节甲板自检流程中，主控上电后自主完成第1、2步，后续步骤通过与甲板软件交互完成，即可以连续执行完成（过程中反馈各环节自检结果），也可以在甲板软件命令控制下单步完成。

### 1.2 甲板自检流程

#### 1.主控程序

电池组上电后，潜器主控程序自动启动，进行程序自身初始化操作。

**自检项：**

① 日志记录功能；

② 主控硬件初始化；

③ 监控线程运行；

④ 守护进程工作情况；

⑤ 各继电器工作情况，包括继电器上下电情况、输出电流等。



#### 2.通讯电台

通讯电台继电器上电，检测电台继电器输出电流。

潜器主控以1Hz频率发送甲板软件握手命令**（0x01，0x02，数据为发送序号）**，等待回复，收到回复后**（0x01，0x02，数据与接收数据相同）**表示与甲板软件建立电台通讯，停止握手包发送。

建立电台通讯后，主控默认开始向甲板软件发送遥测帧，此时遥测帧内只有各继电器工作状态有效，主控各继电器状态信息以位形式表示继电器通断状态，**甲板软件收到继电器状态信息帧后对继电器状态进行显示与实时更新，对应遥测帧中uw_telemetry_relay_state_s**。继电器状态更新频率为0.5Hz。

自检项：

① 电台工作电流；

② 电台通讯；



#### 3.电池组

甲板软件向主控发送开始电池组通讯任务命令**（0x0E，0x00，数据为空）**，主控收到命令后建立与电池组通讯线程，读取当前电池组电流、电压、剩余电量信息，填入遥测帧，更新频率0.2Hz。

此时遥测帧中电池状态信息有效，**甲板软件对电池组信息进行显示，对应遥测帧中uw_telemetry_battery_state_s**（电压、电流、剩余电流）。

自检完成后，遥测帧中电池信息有效。

**自检项：**

① 电池组串口通讯；

② 电池工作电压、电流；

③ 电池剩余电量；



#### 4.电控板

甲板软件向主控发送开始电控板（DAM）通讯任务命令**（0x05，0x01，数据为空）**。

主控收到命令后，电控板(DAM)继电器上电，检测电控板继电器输出电流。

主控与电控板串口建立通讯连接，读取当前各数字IO口和模拟IO口的输出情况。

对空闲端口进行输出操作，包括模拟量输出和数字量输出操作，检测回读信息。

自检完成后，主控向甲板软件发送电控板自检信息**（0x05，0x01，数据为自检结果反馈，uint8_t类型，0-成功，非0-失败）**。

**注意**：电控板自检信息不会在遥测帧中体现，只发送单个数据包信息到甲板软件，甲板软件收到电控板自检信息后，记录信息，如果DAM自检失败，提示错误。

**自检项：**

① 电控板工作电流；

② 电控板串口通讯；

③ 电控板模拟量、数字量输入输出功能；



#### 5.IMU

甲板软件向主控发送IMU上电自检命令**（0x06，0x01，数据为空）**。

主控程序控制IMU继电器上电，检测IMU继电器输出电流。

主控程序根据UW-Navigation手册步骤，启动导航解算任务，检测解算结果有效性。

解算结果有效后，主控向遥测帧中填写导航解算信息，**甲板软件根据遥测帧数据判断IMU自检是否正常**，更新显示潜器状态。遥测帧中IMU信息更新频率为0.5Hz。

对应遥测帧中：uw_telemetry_ins_state_s，uw_telemetry_pose_s，uw_telemetry_vel_s。

**自检项：**

① IMU工作电流；

② 导航解算结果有效性；



#### 6.GPS

甲板软件向主控发送GPS上电自检命令**（0x07，0x01，数据为空）**。

主控程序控制电控板给GPS上电(铱星同时上电)。

主控程序检测解算结果中GPS信息有效性，对比GPS位置偏差。

GPS上电后有搜星过程，自检过程并行执行，并不等待搜星完成，GPS状态在遥测帧中以标志位形式反映。

GPS自检完成后，主控在遥测帧中填写GPS信息，发送给甲板软件，**甲板软件根据遥测帧中GPS信息判断GPS自检状态，**更新显示当前GPS位置信息。遥测帧中GPS信息更新频率为0.5Hz。

对应遥测帧中：uw_telemetry_gps_s。

**自检项：**

① 导航解算结果中GPS信息有效性，GPS位置偏差；



#### 7.关节电机

甲板软件向主控发送关节电机上电自检命令**（0x03，0x01，数据为关节组合ID，1Byte，uint8_t，0-全部关节，1-关节1，2-关节2）**。

主控控制关节电机继电器上电，检测关节电机继电器输出电流。关节电机共4个，分为两组，一组两个配合完成关节动作。

电机上电后，主控启动电机控制CANOpen节点，进行CANOpen初始化，读取当前电机状态字，检测自检关节电机的基本CAN通讯。

自检关节依次进行自检动作：

回左限位：当前关节的两个电机同方向向左执行回左限位动作；回到左限位后，记录当前位置；

回原点：当前关节的两个电机同方向向右执行回原点动作；回到原点后，设置当前位置的绝对位置为0；

回右限位：当前关节的两个电机同方向向右执行回右限位动作；回到右限位后，记录当前位置（相对于原点的绝对位置）；

回左限位：当前关节的两个电机同方向向左执行回左限位动作；回到左限位后，记录当前位置（相对于原点的绝对位置）；

回原点：当前关节的两个电机根据当前位置（相对于原点位置）执行回原点动作；

自检完成后，向甲板软件发送关节电机自检反馈信息，**（0x03，0x01，数据为2Bytes，第一个字节指示关节组合ID，第二个字节指示自检状态，0-自检成功，非0-自检失败）**。

**自检项：**

① 关节电机工作电流；

② 关节电机CAN通讯；

③ 关节电机速度运动、位置运动功能；

④ 关节电机回限位、回原点功能；

⑤ 关节原点位置准确性（外部检测）；



#### 8.主推进器

甲板软件向主控发送主推进器上电自检命令**（0x02，0x01，数据为空）**。

主控程序控制电控板（DAM）给主推进器继电器上电（数字输出），回读数字输出；

读取当前主推进器反馈的转速频率是否为0（DAM频率读取）；

控制主推进器正转，读取转速频率反馈，停止转动，读取转速频率反馈；

控制主推进器反转，读取转速频率反馈，停止转动，读取转速频率反馈；

自检完成后，主控程序向甲板软件发送主推进器自检反馈信息，**（0x02，0x01，数据1Byte，uint8_t，0-自检成功，非0-自检失败）**，甲板软件记录自检信息，如果自检失败，提示错误。

**自检项：**

① 主推进器工作电流；

② 主推进器转速频率反馈；

③ 主推进器正转、反转；





## 二、水面模式





## 三、远航模式





## 四、下潜模式